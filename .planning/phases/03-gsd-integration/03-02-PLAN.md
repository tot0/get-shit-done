---
phase: 03-gsd-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/gsd-pr-sync.js
  - scripts/build-hooks.js
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "When auto_sync is enabled in config, committing on a feature branch automatically updates the PR branch in the background"
    - "Auto-sync does NOT cause infinite loops — re-entrancy guard prevents recursive triggering"
    - "Auto-sync silently exits on main/master branch or when auto_sync is disabled"
    - "Existing user post-commit hooks are preserved — GSD appends with markers, never overwrites"
  artifacts:
    - path: "hooks/gsd-pr-sync.js"
      provides: "Git post-commit hook for auto-sync"
      contains: "GSD_PR_SYNC_RUNNING"
    - path: "scripts/build-hooks.js"
      provides: "Build script including gsd-pr-sync.js in HOOKS_TO_COPY"
      contains: "gsd-pr-sync.js"
    - path: "bin/install.js"
      provides: "Git hook installation with marker-based append"
      contains: "GSD-PR-SYNC"
  key_links:
    - from: "hooks/gsd-pr-sync.js"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "child_process.spawn with GSD_PR_SYNC_RUNNING env var"
      pattern: "spawn.*gsd-tools\\.js.*pr-branch"
    - from: "hooks/gsd-pr-sync.js"
      to: ".planning/config.json"
      via: "fs.readFileSync + JSON.parse"
      pattern: "auto_sync"
    - from: "bin/install.js"
      to: ".git/hooks/post-commit"
      via: "marker-based append (GSD-PR-SYNC-START/END)"
      pattern: "GSD-PR-SYNC"
---

<objective>
Create the auto-sync git post-commit hook and wire it into the build and installer.

Purpose: Enables automatic PR branch updates after each commit (INTG-03). The hook runs as a git post-commit hook (fires on ALL commits, not just during AI sessions), checks config, and spawns gsd-tools.js pr-branch in the background.
Output: Hook script + build integration + installer integration
</objective>

<execution_context>
@/Users/lupickup/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/lupickup/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gsd-integration/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-pr-sync.js post-commit hook</name>
  <files>hooks/gsd-pr-sync.js</files>
  <action>
Create `hooks/gsd-pr-sync.js` — a git post-commit hook that auto-syncs the PR branch.

Follow the patterns established by `hooks/gsd-check-update.js` and `hooks/gsd-statusline.js`:
- Shebang: `#!/usr/bin/env node`
- Comment header explaining purpose
- Silent failure on all errors (never break host app)
- Background spawn for heavy work

The hook logic (in order):

1. **Re-entrancy guard:** Check `process.env.GSD_PR_SYNC_RUNNING === '1'`. If set, `process.exit(0)` immediately. This prevents infinite loops when cherry-picks in the worktree trigger the post-commit hook.

2. **Wrap everything in try/catch with empty catch** — silent failure, consistent with other hooks.

3. **Find project root:** Use `execSync('git rev-parse --show-toplevel')` to get the repo root. This is needed because the hook might run from a subdirectory.

4. **Check if on feature branch:** Use `execSync('git symbolic-ref --short HEAD')` to get current branch name. If on `main`, `master`, or detached HEAD, exit 0 silently.

5. **Read config:** Read `.planning/config.json` from the project root. Parse JSON. Check `pr_branch.auto_sync === true` OR `pr_branch_auto_sync === true` (flat key fallback). If not enabled, exit 0.

6. **Resolve gsd-tools.js path:** The hook is installed to `~/.claude/hooks/` (or equivalent). `gsd-tools.js` is at `../get-shit-done/bin/gsd-tools.js` relative to the hooks directory. Use `path.resolve(__dirname, '..', 'get-shit-done', 'bin', 'gsd-tools.js')`. Check it exists with `fs.existsSync()`, exit if not.

7. **Spawn in background:** Use `child_process.spawn()` with:
   - `process.execPath` (node binary)
   - Args: `[gsdToolsPath, 'pr-branch']`
   - Options: `{ cwd: projectRoot, stdio: 'ignore', detached: true, env: { ...process.env, GSD_PR_SYNC_RUNNING: '1' } }`
   - Call `child.unref()` so the hook exits immediately

Required imports: `fs`, `path`, `child_process` (`spawn`, `execSync`).

Keep the file under 60 lines. No unnecessary abstractions.
  </action>
  <verify>
Verify the file exists and has correct structure:
```bash
head -5 hooks/gsd-pr-sync.js
grep "GSD_PR_SYNC_RUNNING" hooks/gsd-pr-sync.js
grep "auto_sync" hooks/gsd-pr-sync.js
grep "child.unref" hooks/gsd-pr-sync.js
```
Verify it parses without syntax errors:
```bash
node -c hooks/gsd-pr-sync.js
```
  </verify>
  <done>hooks/gsd-pr-sync.js exists, checks re-entrancy guard, reads auto_sync config, spawns gsd-tools.js pr-branch in background with GSD_PR_SYNC_RUNNING=1, parses without errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire hook into build script and installer</name>
  <files>scripts/build-hooks.js, bin/install.js</files>
  <action>
**In `scripts/build-hooks.js`:**

Add `'gsd-pr-sync.js'` to the `HOOKS_TO_COPY` array (after `'gsd-statusline.js'`). This ensures the hook is copied to `hooks/dist/` during `npm run build:hooks` and included in the npm package.

**In `bin/install.js`:**

Add a git hook installation function and call it during install. This requires two changes:

**Change 1: Add `installGitPostCommitHook()` function** (add near the other helper functions, after `buildHookCommand()`):

```javascript
/**
 * Install GSD auto-sync git post-commit hook.
 * Uses marker-based append to preserve existing user hooks.
 * @param {string} configDir - GSD config directory (e.g., ~/.claude)
 * @param {boolean} isGlobal - Whether this is a global install
 */
function installGitPostCommitHook(configDir, isGlobal) {
  // Only install for projects that have a .git directory in cwd
  const cwd = process.cwd();
  const gitDir = path.join(cwd, '.git');
  if (!fs.existsSync(gitDir) || !fs.statSync(gitDir).isDirectory()) return;

  // Respect core.hooksPath if set
  let hooksDir;
  try {
    const { execSync } = require('child_process');
    const hooksPath = execSync('git config core.hooksPath', { encoding: 'utf8', cwd }).trim();
    hooksDir = path.isAbsolute(hooksPath) ? hooksPath : path.resolve(cwd, hooksPath);
  } catch {
    hooksDir = path.join(gitDir, 'hooks');
  }

  if (!fs.existsSync(hooksDir)) {
    fs.mkdirSync(hooksDir, { recursive: true });
  }

  const postCommitPath = path.join(hooksDir, 'post-commit');
  const hookScriptPath = isGlobal
    ? buildHookCommand(configDir, 'gsd-pr-sync.js')
    : 'node ' + path.basename(configDir) + '/hooks/gsd-pr-sync.js';

  const gsdMarker = '# GSD-PR-SYNC-START';
  const gsdEndMarker = '# GSD-PR-SYNC-END';
  const hookCall = gsdMarker + '\n' + hookScriptPath + ' 2>/dev/null || true\n' + gsdEndMarker;

  if (fs.existsSync(postCommitPath)) {
    const existing = fs.readFileSync(postCommitPath, 'utf-8');
    if (existing.includes(gsdMarker)) {
      // Replace existing GSD section
      const replaced = existing.replace(
        new RegExp(gsdMarker + '[\\s\\S]*?' + gsdEndMarker),
        hookCall
      );
      fs.writeFileSync(postCommitPath, replaced);
    } else {
      // Append to existing post-commit hook
      fs.appendFileSync(postCommitPath, '\n' + hookCall + '\n');
    }
  } else {
    // Create new post-commit hook
    fs.writeFileSync(postCommitPath, '#!/bin/sh\n' + hookCall + '\n');
  }

  // Ensure executable (POSIX only, no-op conceptually on Windows)
  try {
    fs.chmodSync(postCommitPath, '755');
  } catch {}

  console.log('  ' + green + '✓' + reset + ' Configured git post-commit hook for PR auto-sync');
}
```

**Change 2: Call the function** at the end of the install process, after the settings.json configuration (after the `return { settingsPath, settings, statuslineCommand, runtime };` line in `performInstall()` — actually look for the right place, it should be called BEFORE the return). Add this just before the return statement:

```javascript
// Install git post-commit hook for PR auto-sync
installGitPostCommitHook(targetDir, isGlobal);
```

**Also update the uninstall function** to remove the GSD section from post-commit hooks. In the uninstall section (near where `settings.hooks.SessionStart` cleanup happens), add cleanup for the git hook:

```javascript
// Remove GSD post-commit hook section
const cwd = process.cwd();
const gitHooksDir = path.join(cwd, '.git', 'hooks');
const postCommitPath = path.join(gitHooksDir, 'post-commit');
if (fs.existsSync(postCommitPath)) {
  const content = fs.readFileSync(postCommitPath, 'utf-8');
  if (content.includes('# GSD-PR-SYNC-START')) {
    const cleaned = content.replace(/\n?# GSD-PR-SYNC-START[\s\S]*?# GSD-PR-SYNC-END\n?/g, '');
    if (cleaned.trim() === '#!/bin/sh' || cleaned.trim() === '') {
      fs.unlinkSync(postCommitPath);
      console.log('  ' + green + '✓' + reset + ' Removed git post-commit hook');
    } else {
      fs.writeFileSync(postCommitPath, cleaned);
      console.log('  ' + green + '✓' + reset + ' Removed GSD section from git post-commit hook');
    }
  }
}
```

**Important:** Reference the `green` and `reset` color constants already defined at the top of install.js. Use the same patterns as the existing hook registration code. The `require('child_process')` for `execSync` in the function is fine — `child_process` is already used elsewhere in the file.
  </action>
  <verify>
Verify build-hooks.js includes gsd-pr-sync:
```bash
grep "gsd-pr-sync" scripts/build-hooks.js
```
Verify install.js has the new function:
```bash
grep "installGitPostCommitHook" bin/install.js
grep "GSD-PR-SYNC" bin/install.js
```
Verify install.js still parses:
```bash
node -c bin/install.js
```
Verify build works:
```bash
npm run build:hooks 2>&1
ls hooks/dist/gsd-pr-sync.js
```
  </verify>
  <done>build-hooks.js copies gsd-pr-sync.js to dist; install.js installs git post-commit hook with marker-based append (respects existing hooks, core.hooksPath), sets 755 permissions; uninstall cleans up GSD section; build:hooks succeeds and hooks/dist/gsd-pr-sync.js exists</done>
</task>

</tasks>

<verification>
- `hooks/gsd-pr-sync.js` exists with re-entrancy guard, config check, background spawn
- `scripts/build-hooks.js` includes `gsd-pr-sync.js` in HOOKS_TO_COPY
- `bin/install.js` has `installGitPostCommitHook()` function with marker-based append
- `npm run build:hooks` succeeds and `hooks/dist/gsd-pr-sync.js` exists
- No syntax errors in any modified files
</verification>

<success_criteria>
- Auto-sync hook follows established hook patterns (silent failure, background spawn)
- Re-entrancy guard uses GSD_PR_SYNC_RUNNING env var (not lock file)
- Installer uses marker-based append to preserve existing post-commit hooks
- Installer respects core.hooksPath git config
- Build script copies hook to dist for npm packaging
- Uninstall cleanly removes GSD section from post-commit hook
</success_criteria>

<output>
After completion, create `.planning/phases/03-gsd-integration/03-02-SUMMARY.md`
</output>
