---
phase: 01-commit-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
autonomous: false

must_haves:
  truths:
    - "Running `node gsd-tools.js pr-branch --dry-run` on a feature branch outputs a categorized list of commits"
    - "The report shows base branch and merge-base commit at the top"
    - "Each commit displays with a type tag (PLAN/CODE/MIX), abbreviated hash, and subject line"
    - "Mixed commits show split file lists (planning files vs code files) with a tip to split"
    - "Summary footer shows category counts and a next-action recommendation"
    - "Timeline is newest-to-oldest (most recent first)"
    - "Filter paths appear in header only when customized beyond defaults"
    - "The --base flag overrides auto-detection"
    - "Edge cases handled: no commits, detached HEAD, base branch not found"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "cmdPrBranch function and CLI router wiring"
      contains: "function cmdPrBranch"
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "CLI router case for pr-branch"
      contains: "case 'pr-branch'"
  key_links:
    - from: "cmdPrBranch"
      to: "resolveBaseBranch"
      via: "calls to resolve base branch from flags/config/auto-detect"
      pattern: "resolveBaseBranch\\(cwd"
    - from: "cmdPrBranch"
      to: "classifyCommit"
      via: "iterates commits, classifies each using filter patterns"
      pattern: "classifyCommit\\(files"
    - from: "cmdPrBranch"
      to: "getCommitFiles"
      via: "gets files for each commit before classification"
      pattern: "getCommitFiles\\(cwd"
    - from: "CLI router case 'pr-branch'"
      to: "cmdPrBranch"
      via: "parses flags and delegates to async cmdPrBranch with .catch"
      pattern: "cmdPrBranch.*\\.catch"
    - from: "cmdPrBranch"
      to: "process.stdout.write"
      via: "writes formatted ANSI report directly (bypasses output() for human-readable mode)"
      pattern: "process\\.stdout\\.write"
---

<objective>
Build the `cmdPrBranch()` subcommand function that orchestrates the engine from Plan 01 into a formatted dry-run report, and wire it into the CLI router with flag parsing.

Purpose: This completes Phase 1 — the user can run `node gsd-tools.js pr-branch --dry-run` on any feature branch and see a categorized timeline of commits with clear next-action guidance.

Output: Fully functional `pr-branch` subcommand producing the report format specified in CONTEXT.md locked decisions.
</objective>

<execution_context>
@/Users/lupickup/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/lupickup/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-commit-pipeline/01-RESEARCH.md
@.planning/phases/01-commit-pipeline/01-CONTEXT.md
@.planning/phases/01-commit-pipeline/01-01-SUMMARY.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmdPrBranch and wire CLI router</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add `cmdPrBranch` function and CLI router wiring to gsd-tools.js. This task combines the subcommand function and router wiring because they're tightly coupled and small independently.

**1. `async function cmdPrBranch(cwd, flags, raw)`** — Add in the Commands section.

The function orchestrates the full dry-run pipeline:

**Step A: Resolve base branch**
- Call `resolveBaseBranch(cwd, config, flags.base)` where config comes from `loadConfig(cwd)`
- If returns null, attempt `promptForBranch()` (async) — if that also fails, call `error()` with the rejection message
- After getting the base branch from prompt, verify it exists with `execGit(cwd, ['rev-parse', '--verify', branch])` — if invalid, `error('Branch "' + branch + '" does not exist')`

**Step B: Find merge base**
- Call `getMergeBase(cwd, baseBranch)`
- If null, `error('Could not find merge base between ' + baseBranch + ' and HEAD')`
- Get abbreviated merge base: `execGit(cwd, ['rev-parse', '--short', mergeBase]).stdout`

**Step C: List and classify commits**
- Convert `config.pr_branch_filter_paths` to RegExp array using `globToRegex()`
- Call `listCommits(cwd, mergeBase)` — already newest-first (git log default = LOCKED decision honored)
- If empty, output message: `'No commits found since divergence from ' + baseBranch + '. Are you on the right branch?'` and exit 0
- For each commit: call `getCommitFiles(cwd, commit.hash, commit.isMerge)`, then `classifyCommit(files, filterPatterns)`
- Build classified commits array with `{ ...commit, ...classification }` (type, planningFiles, codeFiles)

**Step D: Build report (human-readable mode, when NOT --raw)**
Follow the LOCKED report format from CONTEXT.md and RESEARCH.md:

```
Dry-run: pr-branch
──────────────────────────────────────────────────
Base branch: {baseBranch}  Merge base: {shortMergeBase}
Filter paths: {paths}     ← ONLY if config.pr_branch_filter_paths differs from default ['.planning/']
```

For each commit, format based on type:
- Planning: ` PLAN  {hash} {subject}` — PLAN tag in dim/gray
- Code: ` CODE  {hash} {subject}` — CODE tag in green
- Mixed: `{warning} MIX  {hash} {subject}` — MIX tag in yellow, with warning symbol
  - Below mixed: indented file breakdown:
    ```
           Planning: {planningFiles joined with ', '}
           Code:     {codeFiles joined with ', '}
           Tip: Split this commit to rescue code changes
    ```

Use `c()` color helper for tags: dim for PLAN, green for CODE, yellow for MIX warning.
Use `c('dim', ...)` for the horizontal rules.
Use `c('bold', ...)` for header values.

Summary footer:
```
──────────────────────────────────────────────────
Summary: {N} planning · {N} code · {N} mixed
```

After summary, add next-action recommendation:
- If mixed > 0: `'\n{warning} {N} mixed commit(s) need splitting before creating PR branch'` (yellow)
- If mixed === 0 and code > 0: `'\nRun without --dry-run to create PR branch'` (green) — this is forward-looking for Phase 2
- If code === 0 and planning > 0 and mixed === 0: `'\nNo code commits to include in PR branch — all commits are planning-only'`

Write the full report with `process.stdout.write(report + '\n')` then `process.exit(0)`.

**Step E: Raw mode (when --raw)**
When `raw` is true, use `output()` to emit structured JSON:
```javascript
output({
  baseBranch,
  mergeBase: shortMergeBase,
  filterPaths: config.pr_branch_filter_paths,
  commits: classifiedCommits.map(c => ({
    hash: c.hash,
    subject: c.subject,
    type: c.type,
    isMerge: c.isMerge,
    planningFiles: c.planningFiles,
    codeFiles: c.codeFiles,
  })),
  summary: { planning: planCount, code: codeCount, mixed: mixedCount },
}, raw, JSON.stringify({ planning: planCount, code: codeCount, mixed: mixedCount }));
```

**2. CLI Router wiring** — Add a `case 'pr-branch':` block in the switch statement (before the `default:` case):

```javascript
case 'pr-branch': {
  const flags = {};
  let i = 1;
  while (i < args.length) {
    if (args[i] === '--dry-run') { flags.dryRun = true; i++; }
    else if (args[i] === '--base' && args[i + 1]) { flags.base = args[i + 1]; i += 2; }
    else { error('Unknown flag: ' + args[i]); }
  }
  // Phase 1: always dry-run regardless of flag
  flags.dryRun = true;
  cmdPrBranch(cwd, flags, raw).catch(e => { error(e.message); });
  break;
}
```

Note: `cmdPrBranch` is async (because of `promptForBranch()`), so the router handles it with `.catch()`. The process stays alive because readline keeps the event loop running. For the normal (non-prompt) path, the function calls `process.exit(0)` synchronously after writing output.

**3. Update usage string** — Add `pr-branch` to the usage/help text in the `!command` error message and in the file's JSDoc header comment.

**Edge case handling (per research):**
- Detached HEAD: works fine — merge-base operates on HEAD regardless
- No commits in range: handled in Step C with helpful message
- Base branch not found: handled in Step A with prompt fallback or error
- Non-TTY prevents prompt: handled by promptForBranch rejection → error()
  </action>
  <verify>
**Syntax check:**
`node -c get-shit-done/bin/gsd-tools.js` — must pass

**Regression check:**
`node get-shit-done/bin/gsd-tools.js state load --raw` — existing command still works

**Functional check (on current branch):**
`node get-shit-done/bin/gsd-tools.js pr-branch --dry-run` — should produce a report with:
- Header showing base branch and merge base
- Timeline of commits with PLAN/CODE/MIX tags
- Summary footer with counts

**Functional check (raw mode):**
`node get-shit-done/bin/gsd-tools.js pr-branch --dry-run --raw` — should produce valid JSON

**Flag check:**
`node get-shit-done/bin/gsd-tools.js pr-branch --base main --dry-run` — should work with explicit base

**Edge case check:**
`node get-shit-done/bin/gsd-tools.js pr-branch --base nonexistent-branch` — should try auto-detect fallback or error gracefully
  </verify>
  <done>
- `cmdPrBranch` function exists and produces formatted dry-run report
- Report follows LOCKED format: chronological timeline, newest-first, type tags, mixed file breakdown, summary footer
- CLI router has `case 'pr-branch'` with --dry-run and --base flag parsing
- Async handling via .catch() in router
- --raw mode outputs structured JSON via output()
- Base branch printed in report header
- Merge base printed in report header
- Filter paths shown only when customized beyond default
- Summary footer includes category counts and next-action recommendation
- Edge cases handled: no commits, bad base branch, non-TTY
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete pr-branch --dry-run subcommand: commit classification engine + formatted report output in gsd-tools.js</what-built>
  <how-to-verify>
1. Open terminal in the get-shit-done repo directory
2. Run: `node get-shit-done/bin/gsd-tools.js pr-branch --dry-run`
3. Verify the report shows:
   - Header with "Dry-run: pr-branch" and a horizontal rule
   - Base branch (main/master) and merge base hash
   - Timeline of commits with PLAN/CODE/MIX tags in color
   - Any mixed commits show split file lists with a tip
   - Summary footer with counts
   - Next-action recommendation
4. Run: `node get-shit-done/bin/gsd-tools.js pr-branch --dry-run --raw`
5. Verify JSON output with baseBranch, mergeBase, commits array, and summary
6. Run: `node get-shit-done/bin/gsd-tools.js pr-branch --base main`
7. Verify --base flag works
8. Check that existing commands still work: `node get-shit-done/bin/gsd-tools.js state load --raw`
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria (from ROADMAP.md):
1. `node gsd-tools.js pr-branch --dry-run` outputs categorized commit list — VERIFY by running command
2. Tool auto-detects merge base — VERIFY base branch and merge base appear in report header
3. Commits classified as planning-only, code-only, or mixed based on `.planning/` and configured filter paths — VERIFY classification tags in output
4. Tool runs as `pr-branch` subcommand in gsd-tools.js — VERIFY `case 'pr-branch'` exists in router

Requirements coverage:
- FILT-01 (classify commits): classifyCommit() + report output
- BRCH-04 (auto-detect merge base): resolveBaseBranch() + getMergeBase()
- UX-01 (dry-run preview): cmdPrBranch with formatted report
- UX-04 (configurable filter paths): loadConfig pr_branch_filter_paths + globToRegex
- INTG-01 (gsd-tools.js subcommand): case 'pr-branch' in CLI router
</verification>

<success_criteria>
Running `node get-shit-done/bin/gsd-tools.js pr-branch --dry-run` on the current branch produces a colored, formatted report showing each commit since divergence from main/master, classified as PLAN/CODE/MIX, with a summary footer and next-action recommendation. The --base flag works for override. The --raw flag produces structured JSON. All existing gsd-tools.js commands still work.
</success_criteria>

<output>
After completion, create `.planning/phases/01-commit-pipeline/01-02-SUMMARY.md`
</output>
