---
phase: 02-model-abstraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [get-shit-done/bin/gsd-tools.js]
autonomous: true

must_haves:
  truths:
    - "MODEL_PROFILES uses reasoning/standard/fast instead of opus/sonnet/haiku"
    - "PROVIDER_MODELS table maps abstract tiers to provider-specific model IDs for claude, opencode, and gemini"
    - "Runtime is auto-detected from environment variables (GSD_RUNTIME, OPENCODE, GEMINI_API_KEY, CLAUDE_CODE_SSE_PORT)"
    - "GSD_MODEL env var overrides all profile-based resolution"
    - "On Claude Code without override, resolve-model returns opus/sonnet/haiku (backward compatible)"
    - "Unknown agent fallback returns provider-equivalent of standard tier, not hardcoded sonnet"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "Abstract tier MODEL_PROFILES, PROVIDER_MODELS mapping, detectRuntime(), updated cmdResolveModel()"
      contains: "PROVIDER_MODELS"
  key_links:
    - from: "cmdResolveModel()"
      to: "MODEL_PROFILES"
      via: "tier lookup from profile"
      pattern: "MODEL_PROFILES\\[agentType\\]"
    - from: "cmdResolveModel()"
      to: "detectRuntime()"
      via: "runtime detection call"
      pattern: "detectRuntime\\(\\)"
    - from: "cmdResolveModel()"
      to: "PROVIDER_MODELS"
      via: "tier-to-model-ID mapping"
      pattern: "PROVIDER_MODELS\\[runtime\\]"
    - from: "cmdResolveModel()"
      to: "process.env.GSD_MODEL"
      via: "override short-circuit"
      pattern: "process\\.env\\.GSD_MODEL"
---

<objective>
Replace Claude-specific model resolution in gsd-tools.js with abstract capability tiers and provider mapping.

Purpose: Enable gsd-tools.js to return provider-appropriate model IDs (opus for Claude Code, claude-opus-4-6 for OpenCode, gemini-2.5-pro for Gemini) from a single abstract tier system (reasoning/standard/fast), with GSD_MODEL env var override for per-invocation model switching.

Output: Modified `get-shit-done/bin/gsd-tools.js` with abstract MODEL_PROFILES, PROVIDER_MODELS mapping table, detectRuntime() function, and updated cmdResolveModel() that composes tier → runtime → provider-specific model ID.
</objective>

<execution_context>
@/Users/lupickup/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/lupickup/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-abstraction/02-RESEARCH.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add abstract tier tables and runtime detection</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Three changes to gsd-tools.js, all in the top section (lines 24-40 area):

1. **Replace MODEL_PROFILES tier values** (lines 26-38): Change every `'opus'` to `'reasoning'`, every `'sonnet'` to `'standard'`, every `'haiku'` to `'fast'`. The keys (agent names) and structure (quality/balanced/budget) remain identical. Result:

```javascript
const MODEL_PROFILES = {
  'gsd-planner':              { quality: 'reasoning', balanced: 'reasoning', budget: 'standard' },
  'gsd-roadmapper':           { quality: 'reasoning', balanced: 'standard',  budget: 'standard' },
  'gsd-executor':             { quality: 'reasoning', balanced: 'standard',  budget: 'standard' },
  'gsd-phase-researcher':     { quality: 'reasoning', balanced: 'standard',  budget: 'fast' },
  'gsd-project-researcher':   { quality: 'reasoning', balanced: 'standard',  budget: 'fast' },
  'gsd-research-synthesizer': { quality: 'standard',  balanced: 'standard',  budget: 'fast' },
  'gsd-debugger':             { quality: 'reasoning', balanced: 'standard',  budget: 'standard' },
  'gsd-codebase-mapper':      { quality: 'standard',  balanced: 'fast',      budget: 'fast' },
  'gsd-verifier':             { quality: 'standard',  balanced: 'standard',  budget: 'fast' },
  'gsd-plan-checker':         { quality: 'standard',  balanced: 'standard',  budget: 'fast' },
  'gsd-integration-checker':  { quality: 'standard',  balanced: 'standard',  budget: 'fast' },
};
```

2. **Add PROVIDER_MODELS table** immediately after MODEL_PROFILES (before the `// ─── Helpers` section). Include a section comment:

```javascript
// ─── Provider Model Mapping ──────────────────────────────────────────────────

const PROVIDER_MODELS = {
  'claude': {
    reasoning: 'opus',
    standard:  'sonnet',
    fast:      'haiku',
  },
  'opencode': {
    reasoning: 'claude-opus-4-6',
    standard:  'claude-sonnet-4-6',
    fast:      'claude-haiku-3-5',
  },
  'gemini': {
    reasoning: 'gemini-2.5-pro',
    standard:  'gemini-2.5-flash',
    fast:      'gemini-2.0-flash-lite',
  },
};
```

3. **Add detectRuntime() function** immediately after the PROVIDER_MODELS table, before the `// ─── Helpers` section:

```javascript
// ─── Runtime Detection ───────────────────────────────────────────────────────

function detectRuntime() {
  // Explicit override (highest priority)
  if (process.env.GSD_RUNTIME) {
    return process.env.GSD_RUNTIME;
  }
  // OpenCode sets OPENCODE=1 — MUST check before CLAUDE_CODE_SSE_PORT
  // because OpenCode proxies Claude and has both env vars
  if (process.env.OPENCODE === '1') {
    return 'opencode';
  }
  // Gemini CLI detection via Google-specific env vars
  if (process.env.GEMINI_API_KEY || process.env.GOOGLE_GENAI_USE_VERTEXAI) {
    return 'gemini';
  }
  // Claude Code sets CLAUDE_CODE_SSE_PORT in child processes
  if (process.env.CLAUDE_CODE_SSE_PORT) {
    return 'claude';
  }
  // Fallback: default to claude (backward compatible)
  return 'claude';
}
```

CRITICAL ordering: OPENCODE=1 MUST be checked before CLAUDE_CODE_SSE_PORT. OpenCode proxies Claude and sets both env vars — checking CLAUDE_CODE_SSE_PORT first would misdetect OpenCode as Claude Code.
  </action>
  <verify>
Run these commands to verify tables and function exist:

```bash
# MODEL_PROFILES uses abstract tiers (should find reasoning/standard/fast, NOT opus/sonnet/haiku in that table)
grep -A 13 'const MODEL_PROFILES' get-shit-done/bin/gsd-tools.js | grep -c "reasoning\|standard\|fast"

# PROVIDER_MODELS table exists with all 3 providers
grep -A 20 'const PROVIDER_MODELS' get-shit-done/bin/gsd-tools.js

# detectRuntime function exists with correct detection order
grep -A 20 'function detectRuntime' get-shit-done/bin/gsd-tools.js

# opus/sonnet/haiku only appear in PROVIDER_MODELS, not MODEL_PROFILES
grep "'opus'" get-shit-done/bin/gsd-tools.js  # Should only appear in PROVIDER_MODELS section
```
  </verify>
  <done>
MODEL_PROFILES contains only reasoning/standard/fast values. PROVIDER_MODELS maps claude→opus/sonnet/haiku, opencode→claude-opus-4-6/claude-sonnet-4-6/claude-haiku-3-5, gemini→gemini-2.5-pro/gemini-2.5-flash/gemini-2.0-flash-lite. detectRuntime() checks GSD_RUNTIME → OPENCODE → GEMINI_API_KEY/GOOGLE_GENAI_USE_VERTEXAI → CLAUDE_CODE_SSE_PORT → claude fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update cmdResolveModel to use abstract tiers and provider mapping</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Replace the entire `cmdResolveModel` function body (lines 352-370) with the updated version that:

1. **Checks GSD_MODEL override first** — if `process.env.GSD_MODEL` is set, return it immediately as the model, with profile='override' and runtime='override'. This short-circuits all other logic.

2. **Resolves abstract tier from profile** — same as before: load config, get profile, look up agent in MODEL_PROFILES, get tier (reasoning/standard/fast).

3. **Unknown agent fallback** — currently hardcodes `'sonnet'`. Change to: detect runtime, look up PROVIDER_MODELS, return the provider's `standard` tier model. Include `unknown_agent: true` and the runtime/tier in the result.

4. **Maps tier to provider model ID** — call `detectRuntime()`, look up `PROVIDER_MODELS[runtime]`, get the provider-specific model ID for the tier. Fall back to `PROVIDER_MODELS['claude']` if runtime is unknown. Fall back to the raw tier string if the tier isn't in the provider's mapping (defensive).

5. **Include runtime and tier in JSON output** — the `--raw` output still returns just the model string (no contract change). The JSON output (non-raw) now includes `runtime` and `tier` fields for debugging.

Full replacement:

```javascript
function cmdResolveModel(cwd, agentType, raw) {
  if (!agentType) {
    error('agent-type required');
  }

  // 1. GSD_MODEL override takes absolute precedence
  const overrideModel = process.env.GSD_MODEL;
  if (overrideModel) {
    const result = { model: overrideModel, profile: 'override', runtime: 'override' };
    output(result, raw, overrideModel);
    return;
  }

  // 2. Resolve tier from profile
  const config = loadConfig(cwd);
  const profile = config.model_profile || 'balanced';

  const agentModels = MODEL_PROFILES[agentType];
  if (!agentModels) {
    // Unknown agent: use standard tier with provider mapping
    const runtime = detectRuntime();
    const providerModels = PROVIDER_MODELS[runtime] || PROVIDER_MODELS['claude'];
    const model = providerModels['standard'];
    const result = { model, profile, runtime, tier: 'standard', unknown_agent: true };
    output(result, raw, model);
    return;
  }

  const tier = agentModels[profile] || agentModels['balanced'] || 'standard';

  // 3. Map tier to provider-specific model ID
  const runtime = detectRuntime();
  const providerModels = PROVIDER_MODELS[runtime] || PROVIDER_MODELS['claude'];
  const model = providerModels[tier] || tier; // fallback to raw tier if no mapping

  const result = { model, profile, runtime, tier };
  output(result, raw, model);
}
```

IMPORTANT: The `--raw` output contract MUST NOT change. Raw output is a single model string used by callers. Only the JSON (non-raw) output gains the new runtime/tier fields.
  </action>
  <verify>
Run these commands to verify the full resolution chain:

```bash
# SC4: GSD_MODEL override returns exact override value
GSD_MODEL=gpt-5.3-codex node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw
# Expected output: gpt-5.3-codex

# SC5: Backward compatibility — Claude Code default returns opus for quality gsd-planner
# (In Claude Code env, CLAUDE_CODE_SSE_PORT is set, OPENCODE is not)
node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw
# Expected: opus (because gsd-planner balanced=reasoning, and claude reasoning=opus)
# NOTE: If running under OpenCode, expected output is claude-opus-4-6 instead

# JSON output includes runtime and tier
node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner
# Expected: JSON with model, profile, runtime, tier fields

# Unknown agent falls back to provider's standard tier
node get-shit-done/bin/gsd-tools.js resolve-model unknown-agent --raw
# Expected: sonnet (on Claude Code) or claude-sonnet-4-6 (on OpenCode)

# GSD_RUNTIME override for runtime detection
GSD_RUNTIME=gemini node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw
# Expected: gemini-2.5-pro (gemini's reasoning tier)

# Verify --raw output is a plain string, not JSON
GSD_MODEL=test-model node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw | wc -l
# Expected: 1 (single line)
```
  </verify>
  <done>
All 5 success criteria pass: (1) MODEL_PROFILES uses abstract tiers, (2) PROVIDER_MODELS maps tiers to 3 providers, (3) runtime auto-detected from env vars, (4) GSD_MODEL=gpt-5.3-codex returns gpt-5.3-codex, (5) Claude Code default returns opus for quality gsd-planner. Unknown agent fallback returns provider-equivalent of standard tier. --raw output contract preserved (single model string).
  </done>
</task>

</tasks>

<verification>
Run the full verification suite from the research phase:

```bash
# SC1: MODEL_PROFILES uses abstract tiers, not Claude names
grep -A 13 'const MODEL_PROFILES' get-shit-done/bin/gsd-tools.js | grep -c "'opus'\|'sonnet'\|'haiku'"
# Expected: 0

# SC2: PROVIDER_MODELS table exists with all 3 providers
grep -c 'PROVIDER_MODELS' get-shit-done/bin/gsd-tools.js
# Expected: >= 3 (declaration + usages)

# SC3: Runtime auto-detected (JSON output includes runtime field)
node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner 2>&1 | grep runtime
# Expected: "runtime" field present in JSON output

# SC4: GSD_MODEL override
GSD_MODEL=gpt-5.3-codex node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw
# Expected: gpt-5.3-codex

# SC5: Backward compatibility
node get-shit-done/bin/gsd-tools.js resolve-model gsd-planner --raw
# Expected: opus (on Claude Code) or claude-opus-4-6 (on OpenCode)

# Bonus: Cross-runtime verification
GSD_RUNTIME=opencode node get-shit-done/bin/gsd-tools.js resolve-model gsd-executor --raw
# Expected: claude-sonnet-4-6 (opencode standard tier)

GSD_RUNTIME=gemini node get-shit-done/bin/gsd-tools.js resolve-model gsd-codebase-mapper --raw
# Expected: gemini-2.0-flash-lite (gemini fast tier, since codebase-mapper balanced=fast)
```
</verification>

<success_criteria>
1. `grep -A 13 'const MODEL_PROFILES' gsd-tools.js` shows only reasoning/standard/fast — no opus/sonnet/haiku
2. `grep 'PROVIDER_MODELS' gsd-tools.js` confirms table exists with claude, opencode, gemini providers
3. `node gsd-tools.js resolve-model gsd-planner` JSON output includes `runtime` field
4. `GSD_MODEL=gpt-5.3-codex node gsd-tools.js resolve-model gsd-planner --raw` outputs `gpt-5.3-codex`
5. `node gsd-tools.js resolve-model gsd-planner --raw` outputs `opus` on Claude Code (backward compatible)
6. All existing gsd-tools.js commands still work (no regressions in other commands)
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-abstraction/02-01-SUMMARY.md`
</output>
