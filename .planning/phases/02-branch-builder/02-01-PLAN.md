---
phase: 02-branch-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [get-shit-done/bin/gsd-tools.js]
autonomous: true

must_haves:
  truths:
    - "PR branch name is derived from source branch automatically"
    - "Worktree is created in temp directory without touching user's working tree"
    - "Worktree is always cleaned up even on error"
    - "Cherry-pick preserves original author, date, and message"
    - "Cherry-pick conflict is detected, aborted, reported with conflicting files, and worktree is cleaned up"
    - "Mixed commits and merge commits are skipped with warnings"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "getPrBranchName, prBranchExists, createWorktree, removeWorktree, cherryPickCommits helper functions"
      contains: "getPrBranchName"
  key_links:
    - from: "createWorktree"
      to: "fs.mkdtempSync + execGit worktree add"
      via: "function call"
      pattern: "mkdtempSync.*gsd-pr-"
    - from: "removeWorktree"
      to: "execGit worktree remove + worktree prune"
      via: "function call"
      pattern: "worktree.*remove.*force"
    - from: "cherryPickCommits"
      to: "execGit cherry-pick + cherry-pick --abort on failure"
      via: "function call"
      pattern: "cherry-pick.*abort"
---

<objective>
Add worktree lifecycle management, PR branch name derivation, and cherry-pick engine to gsd-tools.js

Purpose: These are the building block functions that Plan 02 will wire into the cmdPrBranch execution flow. Worktree isolation ensures the user's working tree is never touched. The cherry-pick engine handles conflict detection and abort with cleanup.

Output: 5-6 new functions added to gsd-tools.js between the existing helper functions and cmdPrBranch.
</objective>

<execution_context>
@/Users/lupickup/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/lupickup/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-branch-builder/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worktree lifecycle and PR branch name helpers</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add `const os = require('os');` to the requires at the top of the file (after the readline require on line 24).

Add the following functions between `classifyCommit()` (ends ~line 257) and `promptForBranch()` (starts ~line 258). Insert them in this order:

1. **`getPrBranchName(cwd)`** — Derive PR branch name from current branch.
   - `execGit(cwd, ['rev-parse', '--abbrev-ref', 'HEAD'])`
   - If exitCode !== 0 or stdout === 'HEAD' → return null (detached HEAD)
   - Otherwise return `stdout + '-pr'` (e.g., `feature/foo` → `feature/foo-pr`)

2. **`prBranchExists(cwd, branchName)`** — Check if branch exists locally.
   - `execGit(cwd, ['rev-parse', '--verify', branchName]).exitCode === 0`
   - Return boolean

3. **`prBranchPushed(cwd, branchName)`** — Check if branch has been pushed to remote.
   - `execGit(cwd, ['rev-parse', '--verify', 'refs/remotes/origin/' + branchName]).exitCode === 0`
   - Return boolean

4. **`createWorktree(cwd, branchName, startPoint)`** — Create temp worktree for PR branch operations.
   - `const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'gsd-pr-'));`
   - Run `execGit(cwd, ['worktree', 'prune'])` first (crash recovery)
   - Check if branch exists: `execGit(cwd, ['rev-parse', '--verify', branchName]).exitCode === 0`
   - If exists: `execGit(cwd, ['worktree', 'add', tmpDir, branchName])`
   - If not: `execGit(cwd, ['worktree', 'add', '-b', branchName, tmpDir, startPoint])`
   - If exitCode !== 0: cleanup tmpDir with `try { fs.rmdirSync(tmpDir); } catch {}`, return null
   - Return tmpDir on success

5. **`removeWorktree(cwd, worktreePath)`** — Always-safe worktree cleanup.
   - If !worktreePath, return immediately
   - `execGit(cwd, ['worktree', 'remove', '--force', worktreePath])`
   - Belt-and-suspenders: `try { fs.rmSync(worktreePath, { recursive: true, force: true }); } catch {}`
   - `execGit(cwd, ['worktree', 'prune'])`

Follow existing code style: camelCase, 2-space indent, semicolons, JSDoc-style comments are NOT needed (existing helpers don't have them). Each function should be ~5-15 lines. Use the exact `execGit()` patterns already established in the file.
  </action>
  <verify>
Run `node get-shit-done/bin/gsd-tools.js --help 2>&1 || true` — file should parse without syntax errors (outputs usage).
Run `grep -c "function getPrBranchName\|function prBranchExists\|function prBranchPushed\|function createWorktree\|function removeWorktree" get-shit-done/bin/gsd-tools.js` — should output 5.
Run `grep "require('os')" get-shit-done/bin/gsd-tools.js` — should match.
  </verify>
  <done>5 new functions exist in gsd-tools.js: getPrBranchName, prBranchExists, prBranchPushed, createWorktree, removeWorktree. File parses without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add cherry-pick engine with conflict detection</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add the following function after `removeWorktree()` (before `promptForBranch()`):

**`cherryPickCommits(cwd, wtCwd, commitsToCherry)`** — Sequential cherry-pick with conflict detection and abort.

Parameters:
- `cwd` — main repo path (for cleanup/error reporting)
- `wtCwd` — worktree path (where cherry-pick runs)
- `commitsToCherry` — array of `{ hash, subject, type }` objects (code-only commits to pick)

Implementation:
- Initialize results: `const picked = []; const failed = null;`
- Loop over `commitsToCherry` (chronological order — oldest first, matching the order from `listCommits`):
  - Skip if `commit.isMerge` — add to a `skippedMerges` array with warning "merge commit cannot be cherry-picked"
  - Run `execGit(wtCwd, ['cherry-pick', hash])`
  - If exitCode === 0: push to `picked` array
  - If exitCode !== 0:
    - Detect conflict files: `execGit(wtCwd, ['diff', '--name-only', '--diff-filter=U'])` — split stdout by newline, filter empty
    - Also check for "empty cherry-pick" case: if no conflict files AND stderr contains "nothing to commit", treat as already-applied, skip gracefully (push to a `skippedEmpty` array), run `execGit(wtCwd, ['cherry-pick', '--skip'])`, and continue
    - If there ARE conflict files: run `execGit(wtCwd, ['cherry-pick', '--abort'])`, set `failed = { hash, subject, conflictFiles }`, break loop
- Return `{ picked, failed, skippedMerges, skippedEmpty }`

IMPORTANT: Cherry-pick in the WORKTREE (`wtCwd`), never in `cwd`. The function does NOT call removeWorktree — that's the caller's responsibility in a finally block.

Follow existing code patterns. The function should be ~30-40 lines.
  </action>
  <verify>
Run `node get-shit-done/bin/gsd-tools.js --help 2>&1 || true` — file should parse without syntax errors.
Run `grep -c "function cherryPickCommits" get-shit-done/bin/gsd-tools.js` — should output 1.
Run `grep "cherry-pick.*abort" get-shit-done/bin/gsd-tools.js` — should match (conflict handling).
Run `grep "cherry-pick.*skip" get-shit-done/bin/gsd-tools.js` — should match (empty commit handling).
  </verify>
  <done>cherryPickCommits function exists with: sequential cherry-pick loop, conflict detection via diff --name-only --diff-filter=U, cherry-pick --abort on conflict, cherry-pick --skip on empty, merge commit skipping. Returns structured result with picked/failed/skippedMerges/skippedEmpty.</done>
</task>

</tasks>

<verification>
- All 6 new functions parse without error: `node get-shit-done/bin/gsd-tools.js --help 2>&1 || true`
- Functions follow existing patterns: camelCase, execGit() usage, 2-space indent
- `os` module is required at the top of the file
- No existing functionality is broken (pr-branch --dry-run still works)
</verification>

<success_criteria>
- gsd-tools.js has 6 new functions: getPrBranchName, prBranchExists, prBranchPushed, createWorktree, removeWorktree, cherryPickCommits
- os module is required
- File parses without syntax errors
- Existing pr-branch --dry-run command still works
</success_criteria>

<output>
After completion, create `.planning/phases/02-branch-builder/02-01-SUMMARY.md`
</output>
